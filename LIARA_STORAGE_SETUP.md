# راهنمای تنظیم Liara Object Storage

## مراحل تنظیم

### 1. ایجاد Object Storage در لیارا

1. به داشبورد لیارا بروید: https://console.liara.ir
2. از منوی سمت چپ، گزینه **Object Storage** را انتخاب کنید
3. روی دکمه **ایجاد باکت جدید** کلیک کنید
4. یک نام برای باکت انتخاب کنید (مثلاً: `wibecur-images`)
5. باکت را ایجاد کنید

### 2. عمومی کردن باکت (برای نمایش مستقیم تصاویر در مرورگر)

برای اینکه تصاویر بدون پراکسی مستقیم در سایت لود شوند، باکت باید **عمومی** باشد:

1. در [کنسول لیارا](https://console.liara.ir) به **Object Storage** بروید
2. روی **باکت موردنظر** کلیک کنید
3. به تب **تنظیمات** بروید
4. بخش **تغییر سطح دسترسی** را پیدا کنید
5. سطح دسترسی **عمومی (Public)** را انتخاب کنید
6. **تایید** را بزنید

**نکته:** اگر باکت خصوصی بماند، اپ از طریق API پراکسی (`/api/image-proxy`) تصاویر را سرو می‌کند؛ با عمومی کردن باکت بارگذاری مستقیم و سریع‌تر می‌شود.

### 3. دریافت اطلاعات دسترسی

1. روی باکت ایجاد شده کلیک کنید
2. از تب **تنظیمات**، بخش **کلیدهای دسترسی** را پیدا کنید
3. اطلاعات زیر را یادداشت کنید:
   - **Endpoint**: آدرس Object Storage (مثل: `https://storage.iran.liara.space`)
   - **Bucket Name**: نام باکت شما
   - **Access Key ID**: کلید دسترسی
   - **Secret Access Key**: کلید مخفی

### 4. تنظیم در اپلیکیشن

دو روش برای تنظیم وجود دارد:

#### روش 1: استفاده از اسکریپت (توصیه می‌شود)

```bash
npx ts-node scripts/setup-liara-storage.ts
```

اسکریپت از شما اطلاعات زیر را می‌خواهد:
- Endpoint
- Bucket Name
- Access Key ID
- Secret Access Key

#### روش 2: تنظیم دستی در دیتابیس

اگر می‌خواهید مستقیماً در دیتابیس تنظیم کنید:

1. به دیتابیس PostgreSQL متصل شوید
2. کوئری زیر را اجرا کنید (با جایگزینی مقادیر واقعی):

```sql
INSERT INTO settings (key, value)
VALUES ('liara_object_storage', '{"endpoint":"YOUR_ENDPOINT","bucketName":"YOUR_BUCKET_NAME","accessKeyId":"ENCRYPTED_ACCESS_KEY","secretAccessKey":"ENCRYPTED_SECRET_KEY"}')
ON CONFLICT (key)
DO UPDATE SET value = EXCLUDED.value;
```

**توجه:** برای امنیت، `accessKeyId` و `secretAccessKey` باید رمزنگاری شوند.

## تست تنظیمات

پس از تنظیم، می‌توانید با آپلود یک تصویر، تنظیمات را تست کنید:

1. وارد پنل ادمین شوید
2. سعی کنید یک تصویر آپلود کنید
3. اگر تنظیمات صحیح باشد، تصویر در Object Storage ذخیره می‌شود

## ساختار پوشه‌ها در Object Storage

تصاویر در پوشه‌های زیر ذخیره می‌شوند:

- `/user-uploads/` - تصاویر آپلود شده توسط کاربران (آواتار، کاور لیست‌ها)
- `/admin-uploads/` - تصاویر آپلود شده توسط ادمین‌ها
- `/items/` - تصاویر آیتم‌ها (دانلود شده از منابع خارجی)
- `/movies/` - تصاویر فیلم‌ها
- `/posters/` - پوسترهای فیلم‌ها

## مزایای استفاده از Object Storage

1. **سرعت بالا**: تصاویر با سرعت بالا لود می‌شوند
2. **در دسترس بودن**: نگرانی از فیلتر شدن لینک‌های خارجی نیست
3. **امنیت**: تمام تصاویر در سرورهای ایران ذخیره می‌شوند
4. **مدیریت آسان**: تمام تصاویر در یک مکان متمرکز هستند
5. **مقیاس‌پذیری**: فضای ذخیره‌سازی قابل افزایش است

## عیب‌یابی

### خطا: "Liara Object Storage not configured"

- مطمئن شوید که اطلاعات در دیتابیس ذخیره شده است
- جدول `settings` را بررسی کنید و ردیفی با `key='liara_object_storage'` وجود داشته باشد

### خطا: "Error uploading image"

- مطمئن شوید Access Key و Secret Key صحیح هستند
- بررسی کنید که باکت در حالت Public قرار دارد
- مطمئن شوید Endpoint صحیح است

### تصویر آپلود می‌شود اما نمایش داده نمی‌شود

- **باکت را عمومی کنید:** Object Storage → باکت → تنظیمات → تغییر سطح دسترسی → **عمومی** (بخش «عمومی کردن باکت» بالا را ببینید)
- اگر باکت عمومی است و باز هم تصویر نمی‌بینید، اپ به‌صورت خودکار از پراکسی (`/api/image-proxy`) استفاده می‌کند
- در صورت نیاز تنظیمات CORS باکت را در پنل لیارا چک کنید

## پشتیبانی

در صورت بروز مشکل:
1. لاگ‌های سرور را بررسی کنید
2. تنظیمات Object Storage در لیارا را چک کنید
3. مطمئن شوید اطلاعات دسترسی صحیح هستند
