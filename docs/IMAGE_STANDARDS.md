# استانداردهای داده‌های تصویری (اپ موبایل)

این سند تعریف می‌کند که تصاویر در چه سایز و کیفیتی ذخیره و در بخش‌های مختلف اپ نمایش داده می‌شوند. اپ موبایل‌اول است؛ بنابراین ابعاد و بهینه‌سازی برای نمایش در کارت‌ها و فید موبایل (از جمله رتینا ۲x) در نظر گرفته شده‌اند.

## زمان اعمال استانداردها

استانداردها **در زمان آپلود** اعمال می‌شوند، نه در زمان نمایش:

- **آپلود مستقیم توسط کاربر**: آواتار، کاور لیست (از طریق `/api/upload` یا `/api/admin/upload`)
- **آپلود از URL**: وقتی کاربر یا ادمین آدرسی تصویر می‌دهد (مثلاً از جستجو) و تصویر به Liara منتقل می‌شود
- **جستجو / هوش مصنوعی**: وقتی تصویر از منبع خارجی (مثلاً API فیلم) گرفته می‌شود و قبل از ذخیره در دیتابیس به Liara آپلود و بهینه می‌شود

در همهٔ این مسیرها از همان پروفایل‌های تعریف‌شده در `lib/image-config.ts` استفاده می‌شود.

## پروفایل‌ها و کاربرد در اپ

| پروفایل       | کاربرد در اپ                    | حداکثر ابعاد | کیفیت | فرمت  |
|---------------|----------------------------------|---------------|--------|-------|
| **avatar**    | آواتار کاربر (هدر، کامنت، پروفایل) | 400×400       | 85     | WebP  |
| **coverList** | کاور لیست (کارت لیست، جزئیات لیست) | 1000×800      | 85     | WebP  |
| **itemImage** | تصویر آیتم (فید، جزئیات، جستجوی AI) | 1000×900      | 85     | WebP  |
| **itemThumbnail** | تامبنیل آیتم در لیست‌های فشرده   | 800×600       | 80     | WebP  |
| **coverProfile** | کاور پروفایل (استفاده محدود)   | 1000×500      | 85     | WebP  |
| **hubCover**  | کاور هاب (ادمین)                 | 1920×1080     | 85     | WebP  |
| **default**   | fallback                         | 1000×1000     | 80     | WebP  |

- ابعاد **حداکثر** هستند؛ نسبت تصویر حفظ می‌شود و تصویر داخل این قاب قرار می‌گیرد (بدون crop).
- تصاویر کوچک‌تر از حد لازم، بزرگ (upscale) نمی‌شوند.

## نگاشت مسیر آپلود به پروفایل

| منبع / فولدر      | پروفایل     |
|-------------------|-------------|
| آپلود کاربر با `purpose=cover` یا فولدر `covers` | coverList   |
| آپلود کاربر بدون purpose / فولدر `avatars`      | avatar      |
| آپلود ادمین لیست‌کاور / فولدر `lists`            | coverList   |
| آپلود ادمین آواتار / فولدر `avatars`            | avatar      |
| تصویر آیتم (ادمین، کاربر، پیشنهاد، AI) / فولدر `items` | itemImage   |
| پوستر فیلم و مشابه / فولدر `movies`             | itemImage   |

کد نگاشت در `lib/object-storage.ts` (هم برای `uploadImageFromUrl` و هم برای `uploadImageBuffer`) و در APIهای آپلود با استفاده از `validateImage` و پروفایل متناسب با `purpose`/فولدر اعمال شده است.

## اعتبارسنجی قبل از آپلود

در مسیرهای آپلود فایل (`/api/upload`, `/api/admin/upload`) قبل از ارسال به Object Storage از `validateImage` (با پروفایل مناسب) استفاده می‌شود:

- حداکثر حجم ورودی: ۱۰ مگابایت (در API فعلی محدودیت ۵ مگابایت اعمال شده است).
- فرمت‌های مجاز: JPEG، PNG، WebP.
- در صورت نامعتبر بودن تصویر (فرمت، ابعاد، خرابی)، خطای ۴۰۰ با پیام فارسی برگردانده می‌شود.

## فایل‌های مرتبط

- **تعریف پروفایل‌ها**: `lib/image-config.ts`
- **بهینه‌سازی و آپلود**: `lib/image-optimizer.ts`, `lib/object-storage.ts`
- **اعتبارسنجی**: `lib/image-validator.ts`
- **مستندات بهینه‌سازی**: [IMAGE_OPTIMIZATION.md](IMAGE_OPTIMIZATION.md)
- **ذخیره در Liara**: [OBJECT_STORAGE.md](OBJECT_STORAGE.md)

## تغییر استانداردها

برای تغییر ابعاد، کیفیت یا فرمت هر پروفایل، فقط `lib/image-config.ts` را ویرایش کنید. پس از آن همهٔ آپلودهای جدید (کاربر، ادمین، از URL و جستجوی AI) با پروفایل به‌روز شده انجام می‌شوند.
